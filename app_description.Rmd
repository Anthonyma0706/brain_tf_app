---
title: "Description of joint cortex app"
author: "Anthony Ma"
date: "13/05/2020"
output:
  html_document:
    toc: yes
    toc_depth: 2
---
## Goal  
* This app designs for displaying transcription factor and gene data from mice in various fancy ways by three main tabs including:  
  - Given user's TF input, display a table of genes associated with that TF and a network graph visualization displaying detailed information with node color and edge thickness
  - A heatmap which visualizes color gradient using NES(the activity score) per cluster/cell (PS: might be interactive)
  - A scatterplot that, using UMAP cluster algorithm, reduces dimensions in huge cluster genetic data, display closely related clusters. 
  
More details of functions of each tab will be shown later, with major aspects: user input, output, datasets, libraries required and possible demos of plot/table


## To-do list and questions:   
### things need to learn:  
- Keep several layouts in one page  
- heatmap, complex heatmap  
- maybe learn dynamic UI  

### unsolved: 
- use a list to save all datasets?

- Professor mentioned: static data... (contruct this in a big picture... design ability to switch 2 brain regions from the very beginning, and so on. Get a bunch of user input as a vector? then use that vector to do things accordingly and automatically, instead of hardcoding?) maybe this can apply to the theme(parameters of plot...) of the app, but what about other features?
  1. data  
  2. element for the data  
  3. **style** for that element ??
  4. theme elements??
- May 15: New ideas:
  1. User input can be:
    - empty -> we choose one to display initially
    - error (TF not found...) might not be a problem because we let user to select from a given active_TF vector
    - one TF (trivial case)
    - a list of TF (user can select multiple TF from either):
        - direct typing or 
        - **interacting with the graph nodes plot generated from Tab1(cola feature).**  
  2. Keep several layouts in one page  
  3. HEATMAP:  
    - display the **complex heatmap** using that package, that can **interact with user**  
    - Intially, display the heatmap for all the TF(each row is a TF), then user can select several TF to subset the graph
      + This input can also be *taken from the input list form step 1*  
  
  4. UMAP cluster scatterplot: 
    - change the color of dots using colorRampPalette
  
  5. Template (general)
    - **Format contents in different blocks** (instead of hardcoding each situation,
    **but not writing functions?**)
    - ex. A block of code that interacts with user input (TF vector) and

- why can NES have negative value?  
- group those clusters further? neuron.. epithelial...? in Tab2 cluster plot  

### solved: 
- What input do heatmap, scatterplot cluster base on?  - still TF
- display a small table of datasets for demonstration - success
- implementation of UMAP into code, any package? - no need for it, just two columns of forehead data  
- assign training sets to the corresponding tab/plot  
- Detailed definition of joint cortex? - have 5 time plots of pon and forebrain cluster data then join them again into a whole plot to see the overall relations and correlations of each cell

## Library
```{r, message= FALSE}
library(tidyverse)
library(feather)
library(ggplot2)
library(dplyr)

#library(pheatmap)

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Datasets
### 1. Metadata of cluster information
```{r,results='asis', message= FALSE}
cluster_info <- read_tsv("data/joint_cortex/metadata_20190716.tsv")
to_display <- select(cluster_info, -Signature)
knitr::kable(to_display[1:5,1:10], caption = "Table demo [1:5,1:10]")
```  

* with the important columns being:
  + Cluster (matching all the data)
  + Cell_type (the full name of the cell type)
  + Age (the time point of the sample)
  + Colour (a hex value to use as a colour for that cluster)

### 2. Forebrain data (Cortex)
```{r,results='asis', message= FALSE}
forebrain_data <- read_tsv("data/joint_cortex/Forebrain_join.2D.tsv")
knitr::kable(forebrain_data[1:5,], caption = "Table demo")
```

Contains cells from all mouse forebrain samples with joint cluster information and 2D PCA, tSNE and UMAP coordinates in joint space. Clustering/tSNE coordinates are as in Extended Data Figure 1e. The Cell column matches the other datasets, and the **two columns** to use to make scatter plots are **UMAP1 (x-axis) and UMAP2 (y-axis)**.

### 3. Active TF data
```{r,results='asis', message= FALSE}
TF_active <- read_rds("data/joint_cortex/joint_cortex.active_regulons.Rds") # a vector
knitr::kable(TF_active[1:10], caption = "Table demo")
```

Vector of transcription factors declared as active in the sample  
**Note:** will be cleaned by trimming the weights and extensions.  

### 4. TF's target gene data
```{r,results='asis', message= FALSE}
TF_target_gene <- read_rds("data/joint_cortex/joint_cortex.regulon_target_info.Rds")
knitr::kable(TF_target_gene[1:5,], caption = "Table demo")
```

Table indicating the targets ("gene") for each transcription factor ("TF"), and information about the target, including weight and activity

### Activity data (with respect to cell/cluster) 

#### 5. Activity per cluster
```{r,results='asis', message= FALSE}
activity_cluster <- read_feather("data/joint_cortex/joint_cortex.regulon_activity_per_cluster.feather")
knitr::kable(activity_cluster[1:5,1:5], caption = "Table demo")
```

A dataframe, the first column is cluster, subsequent columns correspond to active TF (TF_active) the values describe the NES(activity score of TF in each cluster)

#### 6. Activity per cell 
```{r,results='asis', message= FALSE}
activity_cell <- read_feather("data/joint_cortex/joint_cortex.regulon_activity_per_cell.feather")
knitr::kable(activity_cell[1:5,1:5], caption = "Table demo")
```

The first column changes to cell, we use this for the UMAP cluster scatterplot in tab2.


# Tabs
## 1. table and network
- discription: Given user's TF input, display a table of genes associated with that TF and a network graph visualization displaying detailed information with node color and edge thickness 
- data: 4. TF_target_gene; 5. Activity per cluster
- input: a transcription factor, chosen from (3. Active TF data) vector TF_active
- **package**:  
```{r, message= FALSE}
library(shiny)
library(cyjShiny)
library(htmlwidgets)
library(graph)
library(jsonlite)
```





## 2. Heatmap and cluster scatterplot
- discription: Given user's TF input, display a heatmap and clustering scatterplot
- **package**:  
```{r, message= FALSE}
library(shiny)
library(ggplot2)
library(pheatmap)
```
- data: 4.TF_target_gene, 5. Activity per cluster, 6. Activity per cell
- input: a transcription factor, chosen from (3. Active TF data) vector TF_active
- output: 
  1. A heatmap that, given a specific TF, we filter the activity_cluster datasets with this TF then display a heatmap that shows the level of activity featured by NES(score). You will see a gradient of color which makes a great straightforwad visualization.  
  The x-axis correspond to each cluster.  
  ![alt text](data/image/heatmap_demo3.png)  
  
  2. A scatterplot that plots a scatter plot using UMAP1 and UMAP2 in forebrain_data, then given a user input of TF, using the 6. Activity per cell: activity_cell, change the color of each cell to reflect their TF activity, based on the user input of TF
  ![alt text](data/image/UMAP_demo1.png)  
```{r,results='asis', message= FALSE, echo = TRUE}
activity_test1 <- activity_cell[["E2f1 (122g)"]] # mutate need a vector

# add a activity column
forebrain_with_activity <- mutate(forebrain_data, activity_1 = activity_test1) 

ggplot(data = forebrain_with_activity, mapping = aes(x=UMAP1,y=UMAP2))+
  geom_point(aes(color = activity_1))+
  theme_bw()
```  


```{r,results='asis', message= FALSE, echo = TRUE}
activity_test2 <- activity_cell[[120]] # a very different TF
# add a activity column
forebrain_with_activity <- mutate(forebrain_data, activity_2 = activity_test2) 

ggplot(data = forebrain_with_activity, mapping = aes(x=UMAP1,y=UMAP2))+
  geom_point(aes(color = activity_2))+
  theme_bw()
 
```






## 3. Time series plot
- discription: Given user's TF input, plot a time series trajectory of TF activity in pseudotime.
- **package**:  
```{r, message= FALSE}
library(shiny)
library(ggplot2)
```
- data: 4.TF_target_gene, 5. Activity per cluster, 6. Activity per cell
- input: a transcription factor, chosen from (3. Active TF data) vector TF_active
- output: A time series plot of TF activity in pseudotime
![alt text](data/image/timeseries_1.png)  
Here each dot corresponds to a cell and we can see the type from the colors.
However, in our plot, we are displaying TF activity so the y-axis should be TF activity instead of expression level.
```{r pressure, echo=FALSE}

```

Plot by **pseudotime**: cells that captured at same time will vary vastly in their stage in development progress. To avoid this problem, rather than ploting the changes according to the age, we plot as a function of progress with respect to each cell along its own trajectory, which we term "pseudotime".







